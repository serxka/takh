#include "util/rng.h"
#include "common.h"

static _Thread_local rng_t thrd_rng;

static const u8 perm_table[] = {
        34,  73,  58,  233, 63,  132, 141, 114, 38,  182, 38,  3,   133, 122,
        181, 247, 232, 175, 30,  171, 17,  174, 136, 128, 253, 128, 76,  47,
        44,  239, 86,  79,  56,  145, 56,  120, 21,  197, 234, 59,  123, 17,
        63,  1,   139, 244, 248, 115, 164, 23,  30,  181, 197, 166, 53,  194,
        38,  129, 241, 83,  112, 72,  162, 169, 217, 218, 33,  238, 159, 11,
        41,  27,  28,  104, 28,  167, 93,  20,  26,  1,   43,  56,  182, 241,
        222, 235, 179, 5,   108, 165, 88,  220, 237, 250, 133, 198, 212, 166,
        180, 115, 178, 221, 142, 206, 70,  170, 118, 163, 191, 144, 164, 234,
        201, 90,  219, 167, 69,  143, 172, 177, 52,  4,   141, 33,  254, 19,
        231, 210, 185, 155, 70,  107, 120, 212, 58,  190, 127, 176, 97,  62,
        64,  5,   40,  9,   95,  4,   177, 164, 147, 93,  85,  199, 98,  227,
        232, 96,  246, 207, 51,  175, 106, 121, 27,  226, 77,  85,  161, 204,
        5,   2,   10,  69,  8,   51,  79,  103, 55,  0,   12,  202, 93,  97,
        145, 191, 68,  121, 32,  58,  72,  83,  234, 178, 204, 5,   148, 25,
        90,  53,  230, 95,  56,  240, 164, 64,  35,  243, 167, 90,  243, 179,
        36,  81,  21,  181, 16,  89,  46,  48,  148, 118, 131, 126, 40,  79,
        131, 189, 105, 221, 242, 79,  60,  42,  63,  224, 106, 99,  212, 18,
        189, 199, 197, 226, 24,  218, 151, 41,  52,  198, 89,  200, 60,  221,
        70,  101, 44,  201, 34,  149, 166, 20,  228, 226, 63,  36,  194, 169,
        135, 150, 187, 68,  94,  129, 38,  118, 91,  190, 159, 143, 132, 249,
        87,  192, 214, 157, 37,  2,   102, 71,  152, 12,  92,  124, 238, 155,
        160, 177, 68,  39,  71,  0,   108, 165, 129, 146, 28,  220, 80,  187,
        108, 212, 180, 195, 149, 138, 97,  186, 141, 199, 2,   37,  212, 94,
        161, 194, 249, 66,  115, 61,  105, 187, 61,  213, 96,  190, 104, 124,
        155, 184, 56,  7,   141, 236, 202, 34,  119, 43,  220, 4,   243, 222,
        41,  199, 60,  202, 137, 53,  12,  253, 115, 118, 184, 176, 75,  24,
        111, 179, 149, 10,  108, 205, 17,  249, 185, 219, 27,  48,  7,   247,
        52,  250, 214, 93,  193, 18,  40,  74,  72,  52,  71,  187, 170, 255,
        107, 246, 24,  218, 169, 173, 228, 21,  122, 245, 14,  51,  209, 41,
        100, 216, 33,  152, 210, 247, 246, 147, 9,   30,  221, 81,  82,  37,
        12,  253, 36,  120, 243, 60,  82,  156, 233, 55,  178, 99,  44,  192,
        151, 253, 234, 251, 213, 11,  147, 167, 2,   137, 58,  11,  167, 24,
        93,  250, 61,  105, 247, 97,  225, 234, 158, 52,  134, 135, 107, 56,
        235, 151, 249, 130, 149, 227, 125, 106, 238, 16,  18,  240, 154, 76,
        251, 65,  100, 88,  59,  161, 194, 50,  3,   163, 28,  161, 215, 163,
        40,  66,  219, 19,  218, 212, 149, 111, 183, 18,  217, 165, 35,  235,
        149, 189, 56,  145, 254, 156, 233, 58};
_Static_assert(sizeof(perm_table) == 512, "perm_table wrong size");

static u8 sample(int x, int y, u64 seed) {
	int t = perm_table[(y + 256 + seed) % 512];
	t = perm_table[(x + 256 + t) % 512];
	return t;
}

static double lerp(double a, double b, double x) {
	return a + (b - a) * x;
}

static double slerp(double a, double b, double x) {
	return lerp(a, b, x * x * (3 - 2 * x));
}

static double noise2d(double x, double y, u64 seed) {
	int xi = x;
	int yi = y;
	double xfrac = x - xi;
	double yfrac = y - yi;
	int s = sample(xi, yi, seed);
	int t = sample(xi + 1, yi, seed);
	int u = sample(xi, yi + 1, seed);
	int v = sample(xi + 1, yi + 1, seed);
	double low = slerp(s, t, xfrac);
	double high = slerp(u, v, xfrac);
	return slerp(low, high, yfrac);
}

rng_t *rng_thread(void) {
	return &thrd_rng;
}

double perlin_smpl2d(double x, double y, double freq, u32 depth) {
	rng_t *rng = rng_thread();
	return perlin_smpl2d_s(rng, x, y, freq, depth);
}

double perlin_smpl2d_s(rng_t *rng, double x, double y, double freq, u32 depth) {
	double xa = x * freq;
	double ya = y * freq;
	double amp = 1.0;
	double fin = 0.0;
	double div = 0.0;

	for (u32 i = 0; i < depth; ++i) {
		div += 256.0 * amp;
		fin += noise2d(xa, ya, rng->seed) * amp;
		amp /= 2;
		xa *= 2.0;
		ya *= 2.0;
	}

	return fin / div;
}
